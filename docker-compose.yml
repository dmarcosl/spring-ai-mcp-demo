version: "3.9"

services:
  sales-mcp:
    image: maven:3.9.11-eclipse-temurin-25
    container_name: sales-mcp
    ports:
      - "8084:8084"
    working_dir: /app
    command:
      - bash
      - -lc
      - >
        apt-get update &&
        apt-get install -y git &&
        mkdir -p /app/repo &&
        if [ ! -d /app/repo/.git ]; then
          git clone https://github.com/dmarcosl/spring-ai-mcp-salesmcp /app/repo;
        else
          cd /app/repo && git pull;
        fi &&
        cd /app/repo &&
        mvn -q -DskipTests clean package &&
        java -jar target/salesmcp-0.0.1-SNAPSHOT.jar
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/127.0.0.1/8084'"]
      interval: 3s
      timeout: 2s
      retries: 40
    restart: unless-stopped

  stock-mcp:
    image: maven:3.9.11-eclipse-temurin-25
    container_name: stock-mcp
    ports:
      - "8085:8085"
    working_dir: /app
    command:
      - bash
      - -lc
      - >
        apt-get update &&
        apt-get install -y git &&
        mkdir -p /app/repo &&
        if [ ! -d /app/repo/.git ]; then
          git clone https://github.com/dmarcosl/spring-ai-mcp-stockmcp /app/repo;
        else
          cd /app/repo && git pull;
        fi &&
        cd /app/repo &&
        mvn -q -DskipTests clean package &&
        java -jar target/stockmcp-0.0.1-SNAPSHOT.jar
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/127.0.0.1/8085'"]
      interval: 3s
      timeout: 2s
      retries: 40
    restart: unless-stopped

  mcp-agent:
    image: maven:3.9.11-eclipse-temurin-25
    container_name: mcp-agent
    ports:
      - "8086:8086"
    env_file:
      - .env
    working_dir: /app
    command:
      - bash
      - -lc
      - >
        apt-get update &&
        apt-get install -y git &&
        mkdir -p /app/repo &&
        if [ ! -d /app/repo/.git ]; then
          git clone https://github.com/dmarcosl/spring-ai-mcp-agent /app/repo;
        else
          cd /app/repo && git pull;
        fi &&
        cd /app/repo &&
        mvn -q -DskipTests clean package &&
        java -jar target/agent-0.0.1-SNAPSHOT.jar
    depends_on:
      sales-mcp:
        condition: service_healthy
      stock-mcp:
        condition: service_healthy
    restart: unless-stopped

  front:
    image: node:22-alpine
    container_name: front
    ports:
      - "80:80"
    working_dir: /app
    command:
      - sh
      - -c
      - >
        set -e &&
        apk add --no-cache git nginx &&
        mkdir -p /app/repo &&
        if [ ! -d /app/repo/.git ]; then
          git clone https://github.com/dmarcosl/ai-mcp-front /app/repo;
        else
          cd /app/repo && git pull;
        fi &&
        cd /app/repo &&
        npm install &&
        npm run build -- --configuration=production &&
        mkdir -p /usr/share/nginx/html &&
        cp -r dist/ai-mcp-front/browser/* /usr/share/nginx/html/ &&
        mkdir -p /etc/nginx/http.d &&
        cp nginx.conf /etc/nginx/http.d/default.conf &&
        nginx -t &&
        nginx -g 'daemon off;'
    restart: unless-stopped
